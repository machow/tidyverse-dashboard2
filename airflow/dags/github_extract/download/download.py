# ---
# python_callable: main
# python_callable_partials: 
#
#   # quarto ====
#
#   quarto-dev--quarto-cli: {}
#   quarto-dev--quarto-web: {}
#   quarto-dev--quarto: {}
#   quarto-dev--quarto-r: {}
#   quarto-dev--quarto-actions: {}
#
#   # tidyverse ====
#
#   tidyverse--ggplot2: {}
#   tidyverse--lubridate: {}
#   tidyverse--stringr: {}
#   tidyverse--dplyr: {}
#   tidyverse--readr: {}
#   tidyverse--magrittr: {}
#   tidyverse--tidyr: {}
#   tidyverse--nycflights13: {}
#   tidyverse--rvest: {}
#   tidyverse--purrr: {}
#   tidyverse--haven: {}
#   tidyverse--readxl: {}
#   tidyverse--reprex: {}
#   tidyverse--tibble: {}
#   tidyverse--multidplyr: {}
#   tidyverse--dtplyr: {}
#   tidyverse--hms: {}
#   tidyverse--modelr: {}
#   tidyverse--forcats: {}
#   tidyverse--tidyverse: {}
#   tidyverse--tidytemplate: {}
#   tidyverse--blob: {}
#   tidyverse--ggplot2-docs: {}
#   tidyverse--glue: {}
#   tidyverse--style: {}
#   tidyverse--dbplyr: {}
#   tidyverse--googledrive: {}
#   tidyverse--googlesheets4: {}
#   tidyverse--tidyverse.org: {}
#   tidyverse--tidyversedashboard: {}
#   tidyverse--design: {}
#   tidyverse--tidyeval: {}
#   tidyverse--tidy-dev-day: {}
#   tidyverse--funs: {}
#   tidyverse--vroom: {}
#   tidyverse--website-analytics: {}
#   tidyverse--tidyups: {}
#
#   # r-lib ====
#
#   r-lib--evaluate: {}
#   r-lib--testthat: {}
#   r-lib--devtools: {}
#   r-lib--scales: {}
#   r-lib--memoise: {}
#   r-lib--roxygen2: {}
#   r-lib--httr: {}
#   r-lib--gtable: {}
#   r-lib--pkgdown: {}
#   r-lib--rappdirs: {}
#   r-lib--svglite: {}
#   r-lib--R6: {}
#   r-lib--gmailr: {}
#   r-lib--pkgconfig: {}
#   r-lib--pingr: {}
#   r-lib--crayon: {}
#   r-lib--rex: {}
#   r-lib--lintr: {}
#   r-lib--prettyunits: {}
#   r-lib--progress: {}
#   r-lib--covr: {}
#   r-lib--xml2: {}
#   r-lib--lobstr: {}
#   r-lib--clisymbols: {}
#   r-lib--withr: {}
#   r-lib--rprojroot: {}
#   r-lib--commonmark: {}
#   r-lib--whoami: {}
#   r-lib--gh: {}
#   r-lib--desc: {}
#   r-lib--sodium: {}
#   r-lib--gargle: {}
#   r-lib--remotes: {}
#   r-lib--jose: {}
#   r-lib--backports: {}
#   r-lib--rcmdcheck: {}
#   r-lib--vdiffr: {}
#   r-lib--callr: {}
#   r-lib--mockery: {}
#   r-lib--here: {}
#   r-lib--revdepcheck: {}
#   r-lib--processx: {}
#   r-lib--vctrs: {}
#   r-lib--debugme: {}
#   r-lib--usethis: {}
#   r-lib--rlang: {}
#   r-lib--pkgload: {}
#   r-lib--httrmock: {}
#   r-lib--pkgbuild: {}
#   r-lib--prettycode: {}
#   r-lib--roxygen2md: {}
#   r-lib--pkgapi: {}
#   r-lib--zeallot: {}
#   r-lib--liteq: {}
#   r-lib--keyring: {}
#   r-lib--sloop: {}
#   r-lib--styler: {}
#   r-lib--ansistrings: {}
#   r-lib--archive: {}
#   r-lib--later: {}
#   r-lib--crancache: {}
#   r-lib--zip: {}
#   r-lib--osname: {}
#   r-lib--sessioninfo: {}
#   r-lib--available: {}
#   r-lib--cli: {}
#   r-lib--filelock: {}
#   r-lib--pillar: {}
#   r-lib--tidyselect: {}
#   r-lib--conf: {}
#   r-lib--rematch2: {}
#   r-lib--objectable: {}
#   r-lib--xmlparsedata: {}
#   r-lib--oldie: {}
#   r-lib--pkgdepends: {}
#   r-lib--pkginstall: {}
#   r-lib--coro: {}
#   r-lib--tracer: {}
#   r-lib--pak: {}
#   r-lib--fs: {}
#   r-lib--tar: {}
#   r-lib--showimage: {}
#   r-lib--ghurl: {}
#   r-lib--io: {}
#   r-lib--err: {}
#   r-lib--bench: {}
#   r-lib--cachem: {}
#   r-lib--conflicted: {}
#   r-lib--generics: {}
#   r-lib--ps: {}
#   r-lib--governance: {}
#   r-lib--ellipsis: {}
#   r-lib--carrier: {}
#   r-lib--xopen: {}
#   r-lib--cliapp: {}
#   r-lib--pkgcache: {}
#   r-lib--itdepends: {}
#   r-lib--gert: {}
#   r-lib--devoid: {}
#   r-lib--rray: {}
#   r-lib--credentials: {}
#   r-lib--askpass: {}
#   r-lib--httr2: {}
#   r-lib--lifecycle: {}
#   r-lib--isoband: {}
#   r-lib--decor: {}
#   r-lib--ragg: {}
#   r-lib--cleancall: {}
#   r-lib--fastmap: {}
#   r-lib--ymlthis: {}
#   r-lib--systemfonts: {}
#   r-lib--r-azure-pipelines: {}
#   r-lib--slider: {}
#   r-lib--asciicast: {}
#   r-lib--actions: {}
#   r-lib--r-lib.github.io: {}
#   r-lib--brio: {}
#   r-lib--waldo: {}
#   r-lib--webfakes: {}
#   r-lib--codestate: {}
#   r-lib--hugodown: {}
#   r-lib--downlit: {}
#   r-lib--cpp11: {}
#   r-lib--diffviewer: {}
#   r-lib--textshaping: {}
#   r-lib--gitcreds: {}
#   r-lib--repository-dispatch: {}
#   r-lib--turnstyle: {}
#   r-lib--oskeyring: {}
#   r-lib--urlchecker: {}
#   r-lib--clock: {}
#   r-lib--tree-sitter-r: {}
#   r-lib--ghapps: {}
#   r-lib--memtools: {}
#   r-lib--tzdb: {}
#   r-lib--homebrew-taps: {}
#   r-lib--meltr: {}
#   r-lib--rig: {}
#   r-lib--homebrew-rig: {}
#
#   # r-dbi ====
#
#   r-dbi--RMySQL: {}
#   r-dbi--bigrquery: {}
#   r-dbi--RSQLite: {}
#   r-dbi--DBI: {}
#   r-dbi--RPostgres: {}
#   r-dbi--SQL: {}
#   r-dbi--DBItest: {}
#   r-dbi--RKazam: {}
#   r-dbi--odbc: {}
#   r-dbi--RMariaDB: {}
#   r-dbi--r-dbi.org: {}
#   r-dbi--dblog: {}
#   r-dbi--backends: {}
#   r-dbi--duckadbc: {}
#   r-dbi--setup-postgres: {}
#   r-dbi--setup-sqlserver: {}
#   r-dbi--setup-mariadb: {}
#   r-dbi--dbi3: {}
#   r-dbi--adbc: {}
#   r-dbi--universe: {}
#   
#   # tidymodels ====
#
#   tidymodels--broom: {}
#   tidymodels--corrr: {}
#   tidymodels--recipes: {}
#   tidymodels--rsample: {}
#   tidymodels--infer: {}
#   tidymodels--tidyposterior: {}
#   tidymodels--yardstick: {}
#   tidymodels--parsnip: {}
#   tidymodels--tidypredict: {}
#   tidymodels--modeldb: {}
#   tidymodels--embed: {}
#   tidymodels--tidymodels: {}
#   tidymodels--dials: {}
#   tidymodels--model-implementation-principles: {}
#   tidymodels--textrecipes: {}
#   tidymodels--probably: {}
#   tidymodels--hardhat: {}
#   tidymodels--aml-training: {}
#   tidymodels--baguette: {}
#   tidymodels--tidymodels.org: {}
#   tidymodels--butcher: {}
#   tidymodels--applicable: {}
#   tidymodels--tune: {}
#   tidymodels--workflows: {}
#   tidymodels--discrim: {}
#   tidymodels--themis: {}
#   tidymodels--rules: {}
#   tidymodels--modeldata: {}
#   tidymodels--TMwR: {}
#   tidymodels--poissonreg: {}
#   tidymodels--plsmod: {}
#   tidymodels--multilevelmod: {}
#   tidymodels--planning: {}
#   tidymodels--cloudstart: {}
#   tidymodels--learntidymodels: {}
#   tidymodels--usemodels: {}
#   tidymodels--stacks: {}
#   tidymodels--extratests: {}
#   tidymodels--finetune: {}
#   tidymodels--censored: {}
#   tidymodels--brulee: {}
#   tidymodels--.github: {}
#   tidymodels--workflowsets: {}
#   tidymodels--spatialsample: {}
#   tidymodels--shinymodels: {}
#   tidymodels--survivalauc: {}
#   tidymodels--desirability2: {}
#   tidymodels--tidyclust: {}
#   tidymodels--workshops: {}
#   tidymodels--bonsai: {}
#   tidymodels--agua: {}
#   tidymodels--vetiver-redirect: {}
#   tidymodels--modelenv: {}
#   tidymodels--modeldatatoo: {}
#
#   # misc shiny team repos ====
#   
#   rstudio--DT: {}
#   ramnathv--htmlwidgets: {}
#   plotly--plotly.R: {}
#   rstudio--gradethis: {}
#   rstudio--bslib: {}
#   rstudio--chromote: {}
#   rstudio--crosstalk: {}
#   rstudio--flexdashboard: {}
#   rstudio--fontawesome: {}
#   rstudio--gridlayout: {}
#   rstudio--gt: {}
#   rstudio--htmltools: {}
#   rstudio--httpuv: {}
#   rstudio--jquerylib: {}
#   rstudio--leaflet: {}
#   rstudio--leaflet.providers: {}
#   rstudio--learnr: {}
#   rstudio--plumber: {}
#   rstudio--pool: {}
#   rstudio--profvis: {}
#   rstudio--promises: {}
#   rstudio--py-shiny: {}
#   rstudio--r2d3: {}
#   rstudio--reactlog: {}
#   rstudio--remarker: {}
#   rstudio--rmarkdown: {}
#   rstudio--sass: {}
#   rstudio--shiny: {}
#   rstudio--shiny-server: {}
#   rstudio--shiny-examples: {}
#   rstudio--shinybootstrap2: {}
#   rstudio--shinycannon: {}
#   rstudio--shinycoreci: {}
#   rstudio--shinydashboard: {}
#   rstudio--shinyloadtest: {}
#   rstudio--shinymeta: {}
#   rstudio--shinytest: {}
#   rstudio--shinytest2: {}
#   rstudio--shinythemes: {}
#   rstudio--shinyvalidate: {}
#   rstudio--sortable: {}
#   rstudio--swagger: {}
#   rstudio--thematic: {}
#   rstudio--webdriver: {}
#   rstudio--websocket: {}
#   wch--webshot: {}
#   rstudio--webshot2: {}
#   schloerke--shinyjster: {}
# ---

import os
import tempfile
import pendulum 

from utils import previous_date


def print_repo_args(org):
    """Dumb function to print out all repos for an org, to be used in the yaml."""

    from gh_reader.misc import fetch_owner_repos

    repos = fetch_owner_repos(org)

    for repo in repos:
        print(f"{repo.replace('/', '--')}: {{}}")


def main(ds, task_instance = None, repo_name = None, api_key=None):
    """Fetch and save github data for a repo."""

    from gh_reader.download import Downloader
    from dbpal.config import get_bucket

    import fsspec

    fs = fsspec.filesystem("gs")

    if repo_name is None:
        owner, name = task_instance.task_id.split("--", 1)
    else:
        owner, name = repo_name.split("--")

    if api_key is None:
        # TODO: gusty now attempts to render top-matter like a jinja template at
        # operator *construction*, which means that we can't fetch variables
        # there anymore.
        from airflow.models import Variable

        api_key = Variable.get("EXTRACTOR_GITHUB_TOKEN")


    with tempfile.TemporaryDirectory() as tmp_dir:
        downloader = Downloader(
            tmp_dir,
            api_key = api_key
        )
        downloader.dump_repo(owner, name)

        dst_path = f"{get_bucket()}/github_extract/dt={ds}/{owner}+{name}"

        print(f"Saving to: {dst_path}")

        # similar to using shell cp -r, if the destination directory exists,
        # then put will create a NEW directory inside it. so we need to delete
        # the destination beforehand :/
        if fs.exists(dst_path):
            fs.rm(dst_path, recursive=True)
        fs.put(
            f"{tmp_dir}/{owner}+{name}",
            dst_path,
            recursive=True
        )


if __name__ == "__main__":
    import os
    main("2020-01-01", repo_name="tidyverse--blob", api_key=os.environ["EXTRACTOR_GITHUB_TOKEN"])
